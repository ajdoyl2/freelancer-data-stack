name: "Agent PR Loop"
description: "Automated workflow for agent-driven pull request creation and management"
version: "1.0.0"

commands:
  - name: "create_feature_branch"
    description: "Create a new feature branch for agent work"
    command: |
      echo "ğŸŒ¿ Creating feature branch..."
      # Generate branch name based on current task or timestamp
      BRANCH_NAME="${1:-agent/auto-$(date +%Y%m%d-%H%M%S)}"
      git checkout -b "$BRANCH_NAME"
      echo "âœ… Created and switched to branch: $BRANCH_NAME"

  - name: "commit_changes"
    description: "Commit all changes with AI-generated commit message"
    command: |
      echo "ğŸ’¾ Committing changes..."

      # Check if there are changes to commit
      if git diff --quiet && git diff --cached --quiet; then
        echo "â„¹ï¸ No changes to commit"
        exit 0
      fi

      # Generate commit message based on changes
      COMMIT_MSG="${1:-"feat: AI agent automated improvements

      - Applied code quality improvements
      - Updated dependencies and configurations
      - Enhanced documentation and testing

      Generated by: AI Agent $(date '+%Y-%m-%d %H:%M:%S')"}"

      git add .
      git commit -m "$COMMIT_MSG"
      echo "âœ… Changes committed"

  - name: "run_pre_pr_checks"
    description: "Run comprehensive checks before creating PR"
    command: |
      echo "ğŸ” Running pre-PR checks..."

      # Code quality checks
      echo "ğŸ¨ Code formatting..."
      poetry run black . --check || poetry run black .
      poetry run isort . --check-only || poetry run isort .
      poetry run ruff check . --fix

      # Type checking
      echo "ğŸ” Type checking..."
      poetry run mypy . --ignore-missing-imports || true

      # Tests
      echo "ğŸ§ª Running tests..."
      poetry run pytest tests/ -x -v --tb=short

      # Security scan
      echo "ğŸ”’ Security scan..."
      poetry run bandit -r . -x tests/ || true

      echo "âœ… Pre-PR checks completed"

  - name: "create_pr"
    description: "Create pull request with AI-generated description"
    command: |
      echo "ğŸ“ Creating pull request..."

      BRANCH_NAME=$(git branch --show-current)

      # Generate PR title and description
      PR_TITLE="${1:-"AI Agent: Automated Stack Improvements"}"
      PR_BODY="${2:-"## ğŸ¤– AI Agent Automated Changes

      This PR contains automated improvements generated by AI agents:

      ### Changes Made
      - Code quality improvements and linting fixes
      - Dependency updates and security patches
      - Documentation enhancements
      - Test coverage improvements
      - Configuration optimizations

      ### Validation
      - âœ… All tests passing
      - âœ… Code quality checks passed
      - âœ… Security scan completed
      - âœ… Documentation updated

      ### Review Notes
      - Changes are automatically generated and tested
      - Review focus should be on business logic correctness
      - All automated checks have passed

      Generated: $(date '+%Y-%m-%d %H:%M:%S')
      Branch: $BRANCH_NAME"}"

      # Create PR using GitHub CLI
      gh pr create --title "$PR_TITLE" --body "$PR_BODY" --assignee @me

      echo "âœ… Pull request created successfully"

  - name: "update_pr"
    description: "Update existing PR with new changes"
    command: |
      echo "ğŸ”„ Updating pull request..."

      # Add and commit new changes
      git add .
      git commit -m "chore: AI agent updates - $(date '+%Y-%m-%d %H:%M:%S')" || echo "No new changes to commit"

      # Push to remote
      git push origin "$(git branch --show-current)"

      # Update PR description with latest status
      gh pr edit --body "$(gh pr view --json body -q .body)

      ---
      **Latest Update:** $(date '+%Y-%m-%d %H:%M:%S')
      - Automated improvements applied
      - All checks passing"

      echo "âœ… Pull request updated"

  - name: "check_pr_status"
    description: "Check status of current PR and CI/CD"
    command: |
      echo "ğŸ“Š Checking PR status..."

      # Get PR information
      gh pr status

      # Check CI/CD status
      echo "ğŸ”„ CI/CD Status:"
      gh run list --limit 5

      # Show PR checks
      echo "âœ… PR Checks:"
      gh pr checks

  - name: "auto_merge_pr"
    description: "Automatically merge PR if all checks pass"
    command: |
      echo "ğŸ”€ Checking if PR can be auto-merged..."

      # Check if all checks are passing
      if gh pr checks --watch; then
        echo "âœ… All checks passed, proceeding with merge"

        # Enable auto-merge
        gh pr merge --auto --squash --delete-branch

        echo "ğŸ‰ PR queued for auto-merge"
      else
        echo "âŒ Some checks failed, manual review required"
        gh pr checks
      fi

  - name: "cleanup_merged_branches"
    description: "Clean up merged feature branches"
    command: |
      echo "ğŸ§¹ Cleaning up merged branches..."

      # Switch to main branch
      git checkout main
      git pull origin main

      # Delete merged branches
      git branch --merged | grep -v "main\|master" | xargs -n 1 git branch -d

      # Clean up remote tracking branches
      git remote prune origin

      echo "âœ… Cleanup completed"

workflow_templates:
  quick_pr:
    description: "Quick PR creation workflow"
    steps:
      - create_feature_branch
      - commit_changes
      - run_pre_pr_checks
      - create_pr

  full_pr_cycle:
    description: "Complete PR lifecycle management"
    steps:
      - create_feature_branch
      - commit_changes
      - run_pre_pr_checks
      - create_pr
      - check_pr_status
      - auto_merge_pr
      - cleanup_merged_branches

  update_existing_pr:
    description: "Update an existing PR with new changes"
    steps:
      - commit_changes
      - run_pre_pr_checks
      - update_pr
      - check_pr_status

variables:
  PR_TEMPLATE: |
    ## ğŸ¤– AI Agent Generated PR

    ### Summary
    ${summary}

    ### Changes
    ${changes}

    ### Testing
    - [ ] Unit tests pass
    - [ ] Integration tests pass
    - [ ] Manual testing completed

    ### Checklist
    - [ ] Code follows style guidelines
    - [ ] Documentation updated
    - [ ] Tests added/updated
    - [ ] No breaking changes
